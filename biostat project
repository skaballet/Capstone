#R script for Biostats Project

library(readxl)Model_data_v9 <- read_excel("Model_data_v9.xlsx")
View(Model_data_v9)
setwd("~/Desktop/Desktop/JHSPH/4th Term/Bio624/Project/Malaria")

#Table: High/low RDT STockout, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$RDT2, dnn = c("Prevalence", "RDT"))
fisher.test(Model_data_v9$Choose, Model_data_v9$RDT2)

#Table: High/low ACT STockout, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$ACT2, dnn = c("Prevalence", "ACT"))
fisher.test(Model_data_v9$Choose, Model_data_v9$ACT2)

#Table: High/low ITN STockout, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$ITN2, dnn = c("Prevalence", "ITN"))
fisher.test(Model_data_v9$Choose, Model_data_v9$ITN2)

#Table: Region, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$Region, dnn = c("Prevalence", "Region"))
fisher.test(Model_data_v9$Choose, Model_data_v9$Region)

#Table: High/low RA Non-Availability, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$RA2, dnn = c("Prevalence", "RA"))
fisher.test(Model_data_v9$Choose, Model_data_v9$RA2)

#Table: High/low IPTp Non-Availability, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$IPTp2, dnn = c("Prevalence", "IPTp"))
fisher.test(Model_data_v9$Choose, Model_data_v9$IPTp2)

#Table: High/low Guidelines Non-Availability, High/low Malaria Prevalence
table(Model_data_v9$Choose, Model_data_v9$Guidelines2, dnn = c("Prevalence", "Guidelines"))
fisher.test(Model_data_v9$Choose, Model_data_v9$Guidelines2)

#Univariate log model: RDT
RDT = glm(formula = Choose ~ RDT2, family = binomial(), data = Model_data_v9)
summary(RDT)
exp(confint(RDT))
exp(cbind(Odds_and_OR=coef(RDT, confint(RDT))))

#Univariate log model: ACT
ACT = glm(formula = Choose ~ ACT2, family = binomial(), data = Model_data_v9)
summary(ACT)
exp(confint(ACT))
exp(cbind(Odds_and_OR=coef(ACT, confint(ACT))))

#Univariate log model: ITN
ITN = glm(formula = Choose ~ ITN2, family = binomial(), data = Model_data_v9)
summary(ITN)
exp(confint(ITN))
exp(cbind(Odds_and_OR=coef(ITN, confint(ITN))))

#Univariate log model: Region
Region = glm(formula = Choose ~ Region, family = binomial(), data = Model_data_v9)
summary(Region)
exp(confint(Region))
exp(cbind(Odds_and_OR=coef(Region, confint(Region))))

#Univariate log model: IPTp
IPTp = glm(formula = Choose ~ IPTp2, family = binomial(), data = Model_data_v9)
summary(IPTp)
exp(confint(IPTp))
exp(cbind(Odds_and_OR=coef(IPTp, confint(IPTp))))

#Univariate log model: Guidelines
Guidelines = glm(formula = Choose ~ Guidelines2, family = binomial(), data = Model_data_v9)
summary(Guidelines)
exp(confint(Guidelines))
exp(cbind(Odds_and_OR=coef(Guidelines, confint(Guidelines))))

#Full Multivariate log model
Full = glm(formula = Choose ~ Region + RDT2 +ACT2 + ITN2 +Guidelines2 + RA2 + IPTp2, family = binomial(), data = Model_data_v9)
summary(Full)
exp(confint(Full))
exp(cbind(Odds_and_OR=coef(Full, confint(Full))))

#Interaction: Region*RDT
InteractionRDT = glm(formula = Choose ~ Region + RDT2 +Region*RDT2, family = binomial(), data = Model_data_v9)
summary(InteractionRDT)

#Interaction: Region*ACT
InteractionACT = glm(formula = Choose ~ Region + ACT2 +Region*ACT2, family = binomial(), data = Model_data_v9)
summary(InteractionACT)

#Interaction: Region*ITN
InteractionITN = glm(formula = Choose ~ Region + ITN2 +Region*ITN2, family = binomial(), data = Model_data_v9)
summary(InteractionITN)

#Interaction: Region*Guidelines
InteractionGuidelines = glm(formula = Choose ~ Region + Guidelines2 +Region*Guidelines2, family = binomial(), data = Model_data_v9)
summary(InteractionGuidelines)

#Interaction: Region*RA #CHANGE THIS
InteractionRA = glm(formula = Choose ~ Region + RA2 +Region*RA2, family = binomial(), data = Model_data_v9)
summary(InteractionRA)

#Interaction: Region*IPTp
InteractionIPTp = glm(formula = Choose ~ Region + IPTp2 +Region*IPTp2, family = binomial(), data = Model_data_v9)
summary(InteractionIPTp)

#Log model: Full-IPTp
FullIPTp = glm(formula = Choose ~ Region + RDT2 +ACT2 + ITN2 +Guidelines2 + RA2, family = binomial(), data = Model_data_v9)
summary(FullIPTp)

#Log model: Full-IPTp-RA
FullIPTpRA = glm(formula = Choose ~ Region + RDT2 +ACT2 + ITN2 +Guidelines2, family = binomial(), data = Model_data_v9)
summary(FullIPTpRA)

#Log model: Full-IPTp-RA-Guidelines
FullIPTpRAGuidelines = glm(formula = Choose ~ Region + RDT2 +ACT2 + ITN2, family = binomial(), data = Model_data_v9)
summary(FullIPTpRAGuidelines)

#Log model: Full-IPTp-RA-Guidelines-ITN
FullIPTpRAGuidelinesITN = glm(formula = Choose ~ Region + RDT2 +ACT2, family = binomial(), data = Model_data_v9)
summary(FullIPTpRAGuidelinesITN)

#Log model: Full-IPTp-RA-Guidelines-ITN-ACT
FullIPTpRAGuidelinesITNACT = glm(formula = Choose ~ Region + RDT2, family = binomial(), data = Model_data_v9)
summary(FullIPTpRAGuidelinesITNACT)

#Check full model for collinearity
vif(glm(Choose ~ Region + RDT2 + ACT2 + ITN2 + Guidelines2 + RA2 + IPTp2 , data = Model_data_v9))


#odds graph
boxLabels = c("Region: North", "Region: South", "RDT", "ACT", "ITN", "RA", "IPTp", "Guidelines")

df <- data.frame(yAxis = length(boxLabels):1,
                 boxOdds = (c(2.81, 0.07, 0.59, 1.12, 1.51, 1.98, 0.40, 2.04)),
                 boxCILow = (c(1.12, 0.01, 0.19, 0.45, 0.61, 0.79, 0.11, 0.84)),
                 boxCIHigh = (c(7.37, 0.31, 1.70, 2.77, 3.75, 5.13, 1.41, 5.19))
)


(p <- ggplot(df, aes(x = boxOdds, y = boxLabels)) +
    geom_vline(aes(xintercept = 0), size = .25, linetype = "dashed") +
    geom_errorbarh(aes(xmax = boxCIHigh, xmin = boxCILow), size = .5, height =
                     .2, color = "gray50") +
    geom_point(size = 3.5, color = "orange") +
    scale_x_continuous(breaks = (seq(-1, 8, 1)), labels = seq(-1, 8, 1),
                       limits = (c(-1,8.0))) +
    theme_bw()+
    theme(panel.grid.minor = element_blank()) +
    ylab("") +
    xlab("Odds ratio") +
    annotate(geom = "text", y =1.1, x = 1.5,
             label = "", size = 5.5, hjust = 0) +
    ggtitle("Risk of High Malaria Prevalence")
)
