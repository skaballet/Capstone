#R script 8th cut malaria summary

library(readxl)Model_data_v8 <- read_excel("Model data_v8.xlsx")
View(Model_data)
setwd("~/Desktop/Desktop/JHSPH/Capstone Melissa/R Analysis/Malaria.6thCut")

#create dummy variable
library(fastDummies)
dummy_cols(Model_data_v8$Province)
dummy_var <- dummy_cols(Model_data_v8$Province)

#Change names of Dummy Columns
names(dummy_var)[1] = "ProvinceDV"
names(dummy_var)[c(2:12)] = as.character(unique(Model_data_v8$Province))

#Merge Original dataset and dummy variables
Model_Dummydata = cbind(Model_data_v8, dummy_var)


names(Model_Dummydata)[26] = "Default2"

#find means of each variable-change RDT for desired variable 
library(dplyr)
data.agg <-
  Model_Dummydata %>%
  group_by(Province) %>%
summarise(cnt = n(),
          RDT_mean = mean(RDT, na.rm = TRUE)) %>%
  as.data.frame()
data.agg
       
#Linear regression model RDT
fit1 = lm(Change ~ factor(Province):RDT +RDT, data = Model_Dummydata)
summary(fit1)
confint(fit1)
vif(lm(Change ~ RDT + factor(Province):RDT, data = Model_Dummydata))
fit1a = lm(Change ~ factor(Province):RDT + factor(Province), data = Model_Dummydata)
summary(fit1a)
confint(fit1a)
vif(lm(Change ~ factor(Province) + factor(Province):RDT, data = Model_Dummydata))

#Linear regression model ACT
fit2 = lm(Change ~ ACT+ factor(Province):ACT, data = Model_Dummydata)
summary(fit2)
confint(fit2)
vif(lm(Change ~ ACT + factor(Province):ACT, data = Model_Dummydata))
fit2a = lm(Change ~ factor(Province)+ factor(Province):ACT, data = Model_Dummydata)
summary(fit2a)
confint(fit2a)
vif(lm(Change ~ factor(Province) + factor(Province):ACT, data = Model_Dummydata))

#Linear regression model ITN
fit3 = lm(Change ~ ITN+ factor(Province):ITN, data = Model_Dummydata)
summary(fit3)
confint(fit3)
vif(lm(Change ~ ITN + factor(Province):ITN, data = Model_Dummydata))

#Linear regression model Nurses-colinear drop
fit4 = lm(Change ~ Nurses+ factor(Province):Nurses, data = Model_Dummydata)
summary(fit4)
confint(fit4)
vif(lm(Change ~ Nurses + factor(Province):Nurses, data = Model_Dummydata))

#Linear regression model CHW
fit5 = lm(Change ~ CHW+ factor(Province):CHW, data = Model_Dummydata)
summary(fit5)
confint(fit5)
vif(lm(Change ~ CHW + factor(Province):CHW, data = Model_Dummydata))

#Linear regression model Guidelines
fit6 = lm(Change ~ Guidelines+ factor(Province):Guidelines, data = Model_Dummydata)
summary(fit6)
confint(fit6)
vif(lm(Change ~ Guidelines + factor(Province):Guidelines, data = Model_Dummydata))

#Linear regression model Iptp
fit7 = lm(Change ~ Iptp+ factor(Province):Iptp, data = Model_Dummydata)
summary(fit7)
confint(fit7)
vif(lm(Change ~ Iptp + factor(Province):Iptp, data = Model_Dummydata))

#Linear regression model RA
fit8 = lm(Change ~ RA+ factor(Province):RA, data = Model_Dummydata)
summary(fit8)
confint(fit8)
vif(lm(Change ~ RA + factor(Province):RA, data = Model_Dummydata))

#CI
names(coef(fit1))
## "var1 + var2 = 0" is what determines your linear combination
## If you're interested in the intercept for one of your provinces, you would write "(Intercept) + Province = 0"
## You should eyeball that the combination you're getting makes sense.
glht(fit1, linfct = c("RDT + factor(Province)Nampula:RDT = 0"))
## Get the confidence interval for the linear combination
linear.combination <- glht(fit1, linfct = c("RDT + factor(Province)Nampula:RDT = 0"))
confint(linear.combination))
#change as appropriate
K <- matrix(c(0,1,  # Intercept & RDT
              0,0,  # Gaza & Inhambane
              0,0,  # Manica & Maputo Cidade
              0,0,  # Maputa Provincia & Nampula
              0,0,  # Niassa & Sofala
              0,0,  # Tete & Zambezia
              1,0,  # Gaza & Inhambane (interaction)
              0,0,  # Manica & Maputo Cidade (interaction)
              0,0,  # Maputa Provincia & Nampula (interaction)
              0,0,  # Niassa & Sofala (interaction)
              0,0   # Tete & Zambezia (interaction)
), 1)                      

t <- glht(fit1, linfct = K)
summary(t)

## The effect of a one unit increase in RDT is a 0.1669 (SE = 0.4481) increase in prevalence in Gaza

conf.int <- 0.1669 + c(-1,0,1) * 1.96 * 0.4481

conf.int

#plot residuals
plot(fit1)
#histogram
hist(Model_data_v8$RDT)

#Linear regression model ACT
fit2 = lm(Change ~ factor(Province) + ACT+ factor(Province):ACT, data = Model_Dummydata)
summary(fit2)
#plot residuals
plot(fit2)
#histogram
hist(Model_data_v8$ACT)

#Linear regression model ITN
fit3 = lm(Change ~ factor(Province) + ITN+ factor(Province):ITN, data = Model_Dummydata)
summary(fit3)
#plot residuals
plot(fit3)
#histogram
hist(Model_data_v8$ITN)

#Linear regression model Nurses
fit4 = lm(Change ~ factor(Province) + Nurses+ factor(Province):Nurses, data = Model_Dummydata)
summary(fit4)
#plot residuals
plot(fit4)
#histogram
hist(Model_data_v8$Nurses)

#Linear regression model CHW
fit5 = lm(Change ~ factor(Province) + CHW + factor(Province):CHW , data = Model_Dummydata)
summary(fit5)
#plot residuals
plot(fit5)
#histogram
hist(Model_data_v8$CHW)

#Linear regression model Guidelines
fit6 = lm(Change ~ factor(Province) + Guidelines + factor(Province):Guidelines , data = Model_Dummydata)
summary(fit6)
#plot residuals
plot(fit6)
#histogram
hist(Model_data_v8$Guidelines)








#calculate CI
## Look at the names of your variables
names(coef(fit1))

## "var1 + var2 = 0" is what determines your linear combination
## If you're interested in the intercept for one of your provinces, you would write "(Intercept) + Province = 0"
## You should eyeball that the combination you're getting makes sense.
summary(glht(fit1, linfct = c("RDT + factor(Province)Nampula:RDT = 0")))

## Get the confidence interval for the linear combination
linear.combination <- glht(fit, linfct = c("RDT + factor(Province)Nampula:RDT = 0")
                           confint(linear.combination))

names(coef(fit1))

K <- matrix(c(0,1,  # Intercept & RDT
              0,0,  # Gaza & Inhambane
              0,0,  # Manica & Maputo Cidade
              0,0,  # Maputa Provincia & Nampula
              0,0,  # Niassa & Sofala
              0,0,  # Tete & Zambezia
              1,0,  # Gaza & Inhambane (interaction)
              0,0,  # Manica & Maputo Cidade (interaction)
              0,0,  # Maputa Provincia & Nampula (interaction)
              0,0,  # Niassa & Sofala (interaction)
              0,0   # Tete & Zambezia (interaction)
              ), 1)                      

t <- glht(fit1, linfct = K)
summary(t)

## The effect of a one unit increase in RDT is a 0.1669 (SE = 0.4481) increase in prevalence in Gaza

conf.int <- 0.1669 + c(-1,0,1) * 1.96 * 0.4481

conf.int

#check colinearity
ols_coll_diag(fit1)
